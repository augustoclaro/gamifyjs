const gamify=function(){const t=function(){const t=function(t){const n=[];for(var e in t)n.push(t[e]);return n},n=function(t){return"function"==typeof t},e=function(t){const n=arguments.length;if(2>n||!t)return t;const e=function(t,n,e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))};for(var i=1;n>i;i++)for(var o=arguments[i],r=Object.getOwnPropertyNames(o),a=0;a<r.length;a++)e(o,t,r[a]);return t},i=function(t,n){var i=Object.create(n.prototype);e(i||{},t.prototype||{}),t.prototype=i},o=function(t,n){n.forEach(function(n){t.push(n)})},r=function(t){return{x:t.pos.x,y:t.pos.y,w:t.size.width,h:t.size.height}},a=function(t,n){return t.x<n.x+n.w&&t.x+t.w>n.x&&t.y<n.y+n.h&&t.y+t.h>n.y};return{extend:e,isFunction:n,allValues:t,inherit:i,pushMany:o,box:r,boxCollision:a}}(),n=function(t){const n={},e=function(){};return e.prototype.on=function(e,i){if(!e)throw"Event name can't be null";if(!t.isFunction(i))throw"Invalid event function";return n[e]||(n[e]=[]),n[e].push(i),this},e.prototype.emit=function(t){if(!t)throw"Event name can't be null";var e=Array.prototype.slice.call(arguments,1),i=n[t];i&&i.length&&i.forEach(function(t){t.apply(null,e)})},e}(t),e=function(t,n){const e=function(t,n,e,i){const o=this;o.id="anim-"+t.length+"-"+(new Date).getTime(),o.animating=!0,o.frameIndex=0;const r=t,a=n,c=e,s=i;var u=t[0].time;const f=function(t){t.fromLayer(c.layer||0).renderSprite(a,r[o.frameIndex].sprite,c,s)},h=function(t,n){o.animating&&(f(t),u-=n,0>=u&&(o.frameIndex++,o.frameIndex===r.length&&(o.frameIndex=0,o.emit("animated",o)),u=r[o.frameIndex].time))};o.render=f,o.animate=h};return t.inherit(e,n),e}(t,n),i=function(t,n,e,i){this.name=t,this.type=n,this.dependencies=e,this.fn=i},o=function(t){var n,e,i,o,r;const a=function(){o(n[e],function(){e++,i>e?a():t.isFunction(r)&&r()})},c=function(c,s,u){Array.isArray(c)&&c.length&&t.isFunction(s)&&(n=c,e=0,i=c.length,o=s,r=u,a())};return c}(t),r=function(){const t=function(){this.context.clearRect(0,0,this.element.width,this.element.height)},n=function(){return this.element},e=function(){return this.context},i=function(t){var n=this.context.getImageData(0,0,this.element.width,this.element.height);t.getContext().putImageData(n,0,0,0,0,this.element.width,this.element.height)},o=function(t){t.getContext().drawImage(this.getElement(),0,0,this.size.width,this.size.height)},r=function(t,n){this.element=document.createElement("canvas"),t&&this.element.setAttribute("id",t),this.element.setAttribute("width",n.width),this.element.setAttribute("height",n.height),this.context=this.element.getContext("2d"),this.size=n};return r.prototype={clear:t,getElement:n,getContext:e,transferTo:i,drawTo:o},r}(),a=function(){const t={ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,A:65,W:87,D:68,S:83,SPACE:32},n={left:"l",up:"u",right:"r",down:"d"},e=[t.ARROW_LEFT,t.ARROW_UP,t.ARROW_RIGHT,t.ARROW_DOWN,t.A,t.W,t.D,t.S];return{keys:t,directions:n,directionKeys:e}}(),c=function(){this.lastTick=(new Date).getTime(),this.getElapsedTicks=function(){return this.frameSpacing||0},this.tick=function(t){const n=(new Date).getTime();this.frameSpacing=n-this.lastTick,this.lastTick=n,t&&(this.lastTick-=this.frameSpacing%t)}},s=function(t){const n={},e=function(e,i){const o={},r=function(){Object.keys(o).length===Object.keys(e).length&&t.isFunction(i)&&i(o)},a=function(){n[this.alt]=o[this.alt]=this,r()};for(var c in e)if(e.hasOwnProperty(c))if(n.hasOwnProperty(c))o[c]=n[c],r();else{const s=new Image;s.alt=c,s.onload=a,s.src=e[c]}};return{loadImages:e}}(t),u=function(t){var n,e=t.getElement();this.clearInput=function(){n={leftMouseClick:0,rightMouseClick:0,pressedKeys:[]}},this.clearInput(),this.checkForInput=function(){e.onmousedown=function(t){0===t.button?n.leftMouseClick=1:n.rightMouseClick.leftMouseClick=1},e.onmouseup=function(){n.leftMouseClick=n.rightMouseClick=0},document.onkeydown=function(t){const e=t.keyCode||t.which;-1===n.pressedKeys.indexOf(e)&&n.pressedKeys.push(e)},document.onkeyup=function(t){const e=t.keyCode||t.which,i=n.pressedKeys.indexOf(e);i>-1&&n.pressedKeys.splice(i,1)}},this.getInput=function(){return n}},f=function(t,n){var e=function(){this.loaded=!1};return t.inherit(e,n),e}(t,n),h=function(t,n){if(!t)throw"No game canvas found.";if(!n)throw"No buffer canvas found.";this.canvasGame=t;const e=(n.getContext(),[]);this.getContext=function(n){if(e.length<=n)for(var i=e.length;n>=i;i++)e.push(new r("layer-canvas-"+i,t.size));return e[n].getContext()},this.render=function(n){e.forEach(function(t){t.clear()}),n(),e.forEach(function(n){t.getContext().save(),n.drawTo(t),t.getContext().restore()})}},l=function(t,n){var e=t,i=n.width,o=n.height,r=n.margin||0,a=n.sprites;this.getOffset=function(t){for(var n=0;n<a.length;n++){const e=a[n];if(e.name===t)return{x:e.x*i+r,y:e.y*o+r,width:i-2*r,height:o-2*r,rotate:e.rotate}}return null},this.getImage=function(){return e},this.size={width:i,height:o}};var d=function(t){return function(){this.create=function(n,e){const i=new t;var o,r=e;return{run:function(){o?o-=i.getElapsedTicks():o=r,0>=o&&(o=0,n.apply(null,arguments)),i.tick()},setInterval:function(t){r=t}}}}}(c);const g=function(t){return function(n){const e=function(t){var e=n.animations.map(function(t){return t.id}).indexOf(t.id);if(0>e)throw"Could not found animation "+t;n.animations.splice(e,1)};this.create=function(n,e,i,o){return new t(n,e,i,o)},this.animateOnce=function(t){n.animations.push(t.on("animated",function(t){t.animating=!1}))},this.animate=function(t){n.animations.push(t)},this.stop=e}}(e),m=function(t){return function(n){const e=function(e,i,o,r){if(!i)throw"Watch argument mods1 can't be null";if(!o)throw"Watch argument mods2 can't be null";if(!t.isFunction(r))throw"Watch argument fn must be a function";Array.isArray(i)||(i=[i]),Array.isArray(o)||(o=[o]),n.collisionWatchs[e]={modules1:i,modules2:o,callback:r}};this.watch=e}}(t),p=function(){return function(t){this.getConfig=function(){return t.config}}}();var y=function(t){return function(){this.loadImages=t.loadImages}}(s);const w=function(t){return function(n){this.pressedKeys=function(){var e=n.inputManager.getInput(),i={allKeys:e.pressedKeys};return i.directionKeys=i.allKeys.filter(function(n){return t.directionKeys.indexOf(n)>-1}),i}}}(a),x=(function(t){return t.keys}(a),function(t,n){const e=function(e){var i=function(t){var n=e.getContainerInstance(t);if(!n)throw"Could not find module '"&t&"'";return n};this.load=function(o,r){Array.isArray(o)||(o=[o]),o.forEach(function(o){var r="string"==typeof o?new(i(o)):o;"string"==typeof o&&(r.type=o),t.inherit(r,n),e.moduleManager.register(r)}),e.moduleManager.loadAll(function(){t.isFunction(r)&&r()})},this.unload=function(t){Array.isArray(t)||(t=[t]),t.forEach(function(t){e.moduleManager.unregister(t)})},this.create=function(t){var n=i(t),e=Array.prototype.slice.call(arguments,1);e.unshift(null),n=Function.prototype.bind.apply(n,e);var o=new n;return o.type=t,o}};return e}(t,f)),v=function(){return function(){this.getCenterPoint=function(t,n){return{x:t.x+n.width/2,y:t.y+n.height/2}},this.fromCenterPoint=function(t,n){return{x:t.x-n.width/2,y:t.y-n.height/2}}}}(),C=function(t){return function(n){const e=function(t){var e=this;e.layer=t||0,e.layers={},e.renderCircle=function(t,n,i){const o=e.getContext(e.layer);o.beginPath(),o.fillStyle=i,o.arc(t.x,t.y,n,0,2*Math.PI,!1),o.fill(),o.closePath()},e.renderLine=function(t,n,i,o){const r=e.getContext(e.layer);r.beginPath(),o&&(r.strokeStyle=o),i&&(r.lineWidth=i),r.moveTo(t.x,t.y),r.lineTo(n.x,n.y),r.stroke(),r.closePath()},e.fillBG=function(t){const n=e.getContext(e.layer);n.beginPath(),n.fillStyle=t,n.rect(0,0,n.canvas.width,n.canvas.height),n.fill(),n.closePath()};const i=function(t,n,i,o,r){const a=e.getContext(e.layer);r=r||0;var c=r*Math.PI/180;a.translate(n.x,n.y),a.rotate(c),a.drawImage(t,i.x,i.y,i.width,i.height,o.width/2*-1,o.height/2*-1,o.width,o.height),a.rotate(-1*c),a.translate(-1*n.x,-1*n.y)};e.renderSprite=function(t,e,o,r,a){const c=n.getContainerInstance("$pos");o=o||{x:0,y:0};const s=t.getOffset(e);r=r||{height:s.height,width:s.width};const u=a?o:c.getCenterPoint(o,r);i(t.getImage(),u,s,r,(s.rotate||0)+(o.rotate||0))},e.renderText=function(t,n){const i=e.getContext(e.layer);n.font&&(i.font=n.font),n.color&&(i.fillStyle=n.color),n.align&&(i.textAlign=n.align);var o;n.maxWidth&&(o=n.maxWidth),i.fillText(t,n.pos.x,n.pos.y,o)}};this.fromLayer=function(t){var i=new e(t);return i.getContext=n.renderer.getContext,i},this.fromContext=function(t){var n=new e;return n.getContext=function(){return t},n},this.renderNow=function(e){t.isFunction(e)&&e(n.renderer.canvasGame.getContext())}}}(t),k=function(t){return function(){this.create=function(n,e){return new t(n,e)}}}(l),A=function(){return function(t){this.changeTo=function(n){t.setState(n)}}}(),I=function(t){return function(){const n=new t;this.create=function(t,e){return n.create(t,e)}}}(d),b=function(t){const n=[],e=function(t){n.push(t)},i=function(t){n.splice(n.indexOf(t),1),t.loaded=!1},o=function(t){n.length=0},r=function(e){t(n,function(t,n){t.loaded?n():t.load(function(){t.loaded=!0,n()})},e)},a=function(){n.forEach(function(t){t.loaded&&(t.update(),t.render())})},c=function(t){return n.filter(function(n){return n.type===t})},s=function(){};return s.prototype={register:e,unregister:i,clear:o,loadAll:r,renderAll:a,getByType:c},s}(o),E=function(t,n){const e=new t;var i,o,r;const a=function(t,e){if(i=parseFloat(t),!n.isFunction(e))throw"GameLoop parameter must be a function.";o=e},c=function(){const t=1e3/i;r&&window.requestAnimationFrame(c);const n=e.getElapsedTicks();n>t&&o(n),e.tick(t)},s=function(){r=!0,e.tick(),c()},u=function(){r=!1};return a.prototype={start:s,stop:u},a}(c,t),O=function(t,n,e,i,o,r,a,c,s,u,f,h,l,d,g,m,p,y,w){const x=function(x,v,C){var k=this;const I={size:{width:500,height:500},fps:50,canvasId:"game-canvas-"+(new Date).getTime()},b=x,E=w.extend(I,v),O={},T={},M={},W={},F={};C.forEach(function(t){w.extend(O,t.services),w.extend(T,t.states),w.extend(M,t.modules),w.extend(W,t.consts)});const S=function(t,n,e,i){if(!t)throw i+" must have a name";if(!n||!Array.isArray(n)&&!w.isFunction(n))throw i+" '"&t&"' implementation must be a function or array containing a function.";const o=[];var r=n;if(Array.isArray(n)){for(;n.length&&!w.isFunction(n[0]);)o.push(n.shift());if(!n.length||!w.isFunction(n[0]))throw"Last parameter must be a function at "+t;r=n[0]}if(e[t])throw i+" '"&t&"' exists.";e[t]=new d(t,i,o,r)},P=function(t,n){S(t,n,O,"Service")},R=function(t,n){S(t,n,T,"State")},$=function(t,n){S(t,n,M,"Module")},D=function(t,n){if(!t)throw"Constant must have a name";if(W[t])throw" '"&t&"' exists.";W[t]=n};var K;const z=function(t,n){n||(K=t);const e=[];switch(t.dependencies.forEach(function(n){if(!F[n]){var i=O[n]||T[n]||M[n];if(!i)throw"Could not find dependency '"&n&"' at '"&t.name&"'.";if(i===K)throw"Circular dependency found: '"&K.name&"' -> '"&n&"'";z(i,!0)}e.push(F[n])}),t.type){case"Service":e.unshift(null),F[t.name]=new(Function.prototype.bind.apply(t.fn,e));break;case"State":case"Module":F[t.name]=t.fn.apply(null,e)}},L=function(){w.extend(F,W),F.$game=new g(k),F.$module=new m(k),F.$renderer=new p(k),F.$imageLoader=new s,F.$sprite=new c,F.$input=new i(k),F.$animation=new o(k),F.$collision=new a(k),F.$state=new A(k),F.$timedFunction=new y,F.$pos=new r,F.$keys=t.keys,w.allValues(O).forEach(z),w.allValues(T).forEach(z),w.allValues(M).forEach(z)};var _,N;const j=function(){_=new l(E.canvasId,E.size),N=new l("buffer-canvas-"+(new Date).getTime(),E.size);var t=document.querySelector("[gmf-app='"+b+"']");if(!t)throw"Could not find element to bootstrap game.";t.parentNode.replaceChild(_.getElement(),t)},G=new n;var V;const B=function(t){if(!t)throw"Invalid null argument 'data'.";var n=t;if("string"==typeof t&&(n=T[t]),!n)throw"Could not find state "+t;k.inputManager&&k.inputManager.clearInput(),G.clear(),k.animations=[],k.collisionWatchs={},V=new F[n.name]};var q;k.animations=[];const H=new f,U=function(t){k.animations=k.animations.filter(function(t){return t.animating}),k.animations.forEach(function(n){n.animate(t,H.getElapsedTicks())})},J=function(t){return F[t]};k.collisionWatchs={};const Q=function(){w.allValues(k.collisionWatchs).forEach(function(t){const n=[],e=[];t.modules1.forEach(function(t){"string"==typeof t?w.pushMany(n,G.getByType(t)):n.push(t)}),t.modules2.forEach(function(t){"string"==typeof t?w.pushMany(e,G.getByType(t)):e.push(t)}),n.forEach(function(n){e.forEach(function(e){n.loaded&&e.loaded&&w.boxCollision(w.box(n),w.box(e))&&t.callback(n,e)})})})};var X=!1;const Y=function(){k.renderer=new u(_,N),k.inputManager=new e(_),k.inputManager.checkForInput(),H.tick(),q=new h(E.fps,function(t){const n=function(){V.update(function(){k.renderer.render(function(){Q(),G.renderAll(),H.tick(),U(J("$renderer"))})})};V.loaded?X||n():(X=V.loaded=!0,V.load(function(){X=!1}))}),q.start()},Z=function(){L(),j(),B(E.initialState||w.allValues(T)[0]),Y()};k.name=b,k.config=E,k.services=O,k.states=T,k.modules=M,k.consts=W,k.service=P,k.state=R,k.module=$,k["const"]=D,k.start=Z,k.getContainerInstance=J,k.moduleManager=G,k.setState=B};return x}(a,b,u,w,g,v,m,k,y,h,c,E,r,i,p,x,C,I,t),T=function(t){const n={},e=function(e,i,o){if(i===o===void 0){const r=n[e];if(!r)throw"Could not find game import '"+e+"'";return r}return n[e]=new t(e,i,o)};return{game:e}}(O);return T}();