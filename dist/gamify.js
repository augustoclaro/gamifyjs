const gamify=function(){const t=function(){const t=function(t){const n=[];for(var e in t)n.push(t[e]);return n},n=function(t){return"function"==typeof t},e=function(t){const n=arguments.length;if(2>n||!t)return t;const e=function(t,n,e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))};for(var i=1;n>i;i++)for(var o=arguments[i],r=Object.getOwnPropertyNames(o),c=0;c<r.length;c++)e(o,t,r[c]);return t},i=function(t,n){var i=Object.create(n.prototype);e(i||{},t.prototype||{}),t.prototype=i},o=function(t,n){n.forEach(function(n){t.push(n)})},r=function(t){return{x:t.pos.x,y:t.pos.y,w:t.size.width,h:t.size.height}},c=function(t,n){return t.x<n.x+n.w&&t.x+t.w>n.x&&t.y<n.y+n.h&&t.y+t.h>n.y};return{extend:e,isFunction:n,allValues:t,inherit:i,pushMany:o,box:r,boxCollision:c}}(),n=function(t){const n={},e=function(){};return e.prototype.on=function(e,i){if(!e)throw"Event name can't be null";if(!t.isFunction(i))throw"Invalid event function";return n[e]||(n[e]=[]),n[e].push(i),this},e.prototype.emit=function(t){if(!t)throw"Event name can't be null";var e=Array.prototype.slice.call(arguments,1),i=n[t];i&&i.length&&i.forEach(function(t){t.apply(null,e)})},e}(t),e=function(t,n){const e=function(t,n,e,i){const o=this;o.id="anim-"+t.length+"-"+(new Date).getTime(),o.animating=!0,o.frameIndex=0;const r=t,c=n,a=e,s=i;var u=t[0].time;const f=function(t){t.renderSprite(c,r[o.frameIndex].sprite,a,s)},h=function(t,n){o.animating&&(f(t),u-=n,0>=u&&(o.frameIndex++,o.frameIndex===r.length&&(o.frameIndex=0,o.emit("animated",o)),u=r[o.frameIndex].time))};o.render=f,o.animate=h};return t.inherit(e,n),e}(t,n),i=function(t,n,e,i){this.name=t,this.type=n,this.dependencies=e,this.fn=i},o=function(t){var n,e,i,o,r;const c=function(){o(n[e],function(){e++,i>e?c():t.isFunction(r)&&r()})},a=function(a,s,u){Array.isArray(a)&&a.length&&t.isFunction(s)&&(n=a,e=0,i=a.length,o=s,r=u,c())};return a}(t),r=function(){const t=function(){this.context.clearRect(0,0,this.element.width,this.element.height)},n=function(){return this.element},e=function(){return this.context},i=function(t){var n=this.context.getImageData(0,0,this.element.width,this.element.height);t.getContext().putImageData(n,0,0,0,0,this.element.width,this.element.height)},o=function(t,n){this.element=document.createElement("canvas"),t&&this.element.setAttribute("id",t),this.element.setAttribute("width",n.width),this.element.setAttribute("height",n.height),this.context=this.element.getContext("2d")};return o.prototype={clear:t,getElement:n,getContext:e,transferTo:i},o}(),c=function(){const t={ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,A:65,W:87,D:68,S:83,SPACE:32},n={left:"l",up:"u",right:"r",down:"d"},e=[t.ARROW_LEFT,t.ARROW_UP,t.ARROW_RIGHT,t.ARROW_DOWN,t.A,t.W,t.D,t.S];return{keys:t,directions:n,directionKeys:e}}(),a=function(){this.lastTick=(new Date).getTime(),this.getElapsedTicks=function(){return this.frameSpacing||0},this.tick=function(t){const n=(new Date).getTime();this.frameSpacing=n-this.lastTick,this.lastTick=n,t&&(this.lastTick-=this.frameSpacing%t)}},s=function(t){const n={},e=function(e,i){const o={},r=function(){Object.keys(o).length===Object.keys(e).length&&t.isFunction(i)&&i(o)},c=function(){n[this.alt]=o[this.alt]=this,r()};for(var a in e)if(e.hasOwnProperty(a))if(n.hasOwnProperty(a))o[a]=n[a],r();else{const s=new Image;s.alt=a,s.onload=c,s.src=e[a]}};return{loadImages:e}}(t),u=function(t){var n,e=t.getElement();this.clearInput=function(){n={leftMouseClick:0,rightMouseClick:0,pressedKeys:[]}},this.clearInput(),this.checkForInput=function(){e.onmousedown=function(t){0===t.button?n.leftMouseClick=1:n.rightMouseClick.leftMouseClick=1},e.onmouseup=function(){n.leftMouseClick=n.rightMouseClick=0},document.onkeydown=function(t){const e=t.keyCode||t.which;-1===n.pressedKeys.indexOf(e)&&n.pressedKeys.push(e)},document.onkeyup=function(t){const e=t.keyCode||t.which,i=n.pressedKeys.indexOf(e);i>-1&&n.pressedKeys.splice(i,1)}},this.getInput=function(){return n}},f=function(t,n){var e=function(){this.loaded=!1};return t.inherit(e,n),e}(t,n),h=function(t,n){if(!t)throw"No game canvas found.";if(!n)throw"No buffer canvas found.";const e=n.getContext();this.getContext=function(){return e},this.render=function(e){n.clear(),e(),n.transferTo(t)}},l=function(t,n){var e=t,i=n.width,o=n.height,r=n.margin||0,c=n.sprites;this.getOffset=function(t){for(var n=0;n<c.length;n++){const e=c[n];if(e.name===t)return{x:e.x*i+r,y:e.y*o+r,width:i-2*r,height:o-2*r,rotate:e.rotate}}return null},this.getImage=function(){return e},this.size={width:i,height:o}};var d=function(t){return function(){this.create=function(n,e){const i=new t;var o,r=e;return{run:function(){o?o-=i.getElapsedTicks():o=r,0>=o&&(o=0,n.apply(null,arguments)),i.tick()},setInterval:function(t){r=t}}}}}(a);const m=function(t){return function(n){const e=function(t){var e=n.animations.map(function(t){return t.id}).indexOf(t.id);if(0>e)throw"Could not found animation "+t;n.animations.splice(e,1)};this.create=function(n,e,i,o){return new t(n,e,i,o)},this.animateOnce=function(t){n.animations.push(t.on("animated",function(t){t.animating=!1}))},this.animate=function(t){n.animations.push(t)},this.stop=e}}(e),g=function(t){return function(n){const e=function(e,i,o,r){if(!i)throw"Watch argument mods1 can't be null";if(!o)throw"Watch argument mods2 can't be null";if(!t.isFunction(r))throw"Watch argument fn must be a function";Array.isArray(i)||(i=[i]),Array.isArray(o)||(o=[o]),n.collisionWatchs[e]={modules1:i,modules2:o,callback:r}};this.watch=e}}(t),p=function(t){return function(n){var e=new t;this.getConfig=function(){return n.config},this.createTimedFunction=function(t,n){return e.create(t,n)}}}(d);var y=function(t){return function(){this.loadImages=t.loadImages}}(s);const w=function(t){return function(n){this.pressedKeys=function(){var e=n.inputManager.getInput(),i={allKeys:e.pressedKeys};return i.directionKeys=i.allKeys.filter(function(n){return t.directionKeys.indexOf(n)>-1}),i}}}(c),x=(function(t){return t.keys}(c),function(t,n){const e=function(e){var i=function(t){var n=e.getContainerInstance(t);if(!n)throw"Could not find module '"&t&"'";return n};this.load=function(o,r){Array.isArray(o)||(o=[o]),o.forEach(function(o){var r="string"==typeof o?new(i(o)):o;"string"==typeof o&&(r.type=o),t.inherit(r,n),e.moduleManager.register(r)}),e.moduleManager.loadAll(function(){t.isFunction(r)&&r()})},this.unload=function(t){Array.isArray(t)||(t=[t]),t.forEach(function(t){e.moduleManager.unregister(t)})},this.create=function(t){var n=i(t),e=Array.prototype.slice.call(arguments,1);e.unshift(null),n=Function.prototype.bind.apply(n,e);var o=new n;return o.type=t,o}};return e}(t,f)),v=function(){return function(){this.getCenterPoint=function(t,n){return{x:t.x+n.width/2,y:t.y+n.height/2}},this.fromCenterPoint=function(t,n){return{x:t.x-n.width/2,y:t.y-n.height/2}}}}(),C=function(t){var n=this;n.getContext=function(){return t.renderer.getContext()},n.renderCircle=function(t,e,i){const o=n.getContext();o.beginPath(),o.fillStyle=i,o.arc(t.x,t.y,e,0,2*Math.PI,!1),o.fill(),o.closePath()},n.fillBG=function(t){const e=n.getContext();e.beginPath(),e.fillStyle=t,e.rect(0,0,e.canvas.width,e.canvas.height),e.fill(),e.closePath()};const e=function(t,e,i,o,r){const c=n.getContext();r=r||0;var a=r*Math.PI/180;c.translate(e.x,e.y),c.rotate(a),c.drawImage(t,i.x,i.y,i.width,i.height,o.width/2*-1,o.height/2*-1,o.width,o.height),c.rotate(-1*a),c.translate(-1*e.x,-1*e.y)};n.renderSprite=function(n,i,o,r,c){const a=t.getContainerInstance("$pos");o=o||{x:0,y:0};const s=n.getOffset(i);r=r||{height:s.height,width:s.width};const u=c?o:a.getCenterPoint(o,r);e(n.getImage(),u,s,r,(s.rotate||0)+(o.rotate||0))},n.renderText=function(t,e){const i=n.getContext();e.font&&(i.font=e.font),e.color&&(i.fillStyle=e.color),e.align&&(i.textAlign=e.align);var o;e.maxWidth&&(o=e.maxWidth),i.fillText(t,e.pos.x,e.pos.y,o)}},k=function(t){return function(){this.create=function(n,e){return new t(n,e)}}}(l),A=function(){return function(t){this.changeTo=function(n){t.setState(n)}}}(),b=function(t){const n=[],e=function(t){n.push(t)},i=function(t){n.splice(n.indexOf(t),1),t.loaded=!1},o=function(t){n.length=0},r=function(e){t(n,function(t,n){t.loaded?n():t.load(function(){t.loaded=!0,n()})},e)},c=function(){n.forEach(function(t){t.loaded&&(t.update(),t.render())})},a=function(t){return n.filter(function(n){return n.type===t})},s=function(){};return s.prototype={register:e,unregister:i,clear:o,loadAll:r,renderAll:c,getByType:a},s}(o),I=function(t,n){const e=new t;var i,o,r;const c=function(t,e){if(i=parseFloat(t),!n.isFunction(e))throw"GameLoop parameter must be a function.";o=e},a=function(){const t=1e3/i;r&&window.requestAnimationFrame(a);const n=e.getElapsedTicks();n>t&&o(n),e.tick(t)},s=function(){r=!0,e.tick(),a()},u=function(){r=!1};return c.prototype={start:s,stop:u},c}(a,t),E=function(t,n,e,i,o,r,c,a,s,u,f,h,l,d,m,g,p,y){const w=function(w,x,v){var C=this;const k={size:{width:500,height:500},fps:50,canvasId:"game-canvas-"+(new Date).getTime()},b=w,I=y.extend(k,x),E={},O={},T={},M={},W={};v.forEach(function(t){y.extend(E,t.services),y.extend(O,t.states),y.extend(T,t.modules),y.extend(M,t.consts)});const F=function(t,n,e,i){if(!t)throw i+" must have a name";if(!n||!Array.isArray(n)&&!y.isFunction(n))throw i+" '"&t&"' implementation must be a function or array containing a function.";const o=[];var r=n;if(Array.isArray(n)){for(;n.length&&!y.isFunction(n[0]);)o.push(n.shift());if(!n.length||!y.isFunction(n[0]))throw"Last parameter must be a function at "+t;r=n[0]}if(e[t])throw i+" '"&t&"' exists.";e[t]=new d(t,i,o,r)},R=function(t,n){F(t,n,E,"Service")},S=function(t,n){F(t,n,O,"State")},P=function(t,n){F(t,n,T,"Module")},$=function(t,n){if(!t)throw"Constant must have a name";if(M[t])throw" '"&t&"' exists.";M[t]=n};var D;const K=function(t,n){n||(D=t);const e=[];switch(t.dependencies.forEach(function(n){if(!W[n]){var i=E[n]||O[n]||T[n];if(!i)throw"Could not find dependency '"&n&"' at '"&t.name&"'.";if(i===D)throw"Circular dependency found: '"&D.name&"' -> '"&n&"'";K(i,!0)}e.push(W[n])}),t.type){case"Service":e.unshift(null),W[t.name]=new(Function.prototype.bind.apply(t.fn,e));break;case"State":case"Module":W[t.name]=t.fn.apply(null,e)}},_=function(){y.extend(W,M),W.$game=new m(C),W.$module=new g(C),W.$renderer=new p(C),W.$imageLoader=new s,W.$sprite=new a,W.$input=new i(C),W.$animation=new o(C),W.$collision=new c(C),W.$state=new A(C),W.$pos=new r,W.$keys=t.keys,y.allValues(E).forEach(K),y.allValues(O).forEach(K),y.allValues(T).forEach(K)};var j,z;const N=function(){j=new l(I.canvasId,I.size),z=new l("buffer-canvas-"+(new Date).getTime(),I.size);var t=document.querySelector("[gmf-app='"+b+"']");if(!t)throw"Could not find element to bootstrap game.";t.parentNode.replaceChild(j.getElement(),t)},V=new n;var L;const B=function(t){if(!t)throw"Invalid null argument 'data'.";var n=t;if("string"==typeof t&&(n=O[t]),!n)throw"Could not find state "+t;V.clear(),C.animations=[],C.collisionWatchs={},L=new W[n.name]};var G;C.animations=[];const q=new f,H=function(t){C.animations=C.animations.filter(function(t){return t.animating}),C.animations.forEach(function(n){n.animate(t,q.getElapsedTicks())})},U=function(t){return W[t]};C.collisionWatchs={};const J=function(){y.allValues(C.collisionWatchs).forEach(function(t){const n=[],e=[];t.modules1.forEach(function(t){"string"==typeof t?y.pushMany(n,V.getByType(t)):n.push(t)}),t.modules2.forEach(function(t){"string"==typeof t?y.pushMany(e,V.getByType(t)):e.push(t)}),n.forEach(function(n){e.forEach(function(e){n.loaded&&e.loaded&&y.boxCollision(y.box(n),y.box(e))&&t.callback(n,e)})})})};var Q=!1;const X=function(){C.renderer=new u(j,z),C.inputManager=new e(j),C.inputManager.checkForInput(),q.tick(),G=new h(I.fps,function(t){const n=function(){L.update(function(){C.renderer.render(function(){J(),V.renderAll(),q.tick(),H(U("$renderer"))})})};L.loaded?Q||n():(Q=L.loaded=!0,L.load(function(){Q=!1}))}),G.start()},Y=function(){_(),N(),B(I.initialState||y.allValues(O)[0]),X()};C.name=b,C.config=I,C.services=E,C.states=O,C.modules=T,C.consts=M,C.service=R,C.state=S,C.module=P,C["const"]=$,C.start=Y,C.getContainerInstance=U,C.moduleManager=V,C.setState=B};return w}(c,b,u,w,m,v,g,k,y,h,a,I,r,i,p,x,C,t),O=function(t){const n={},e=function(e,i,o){if(i===o===void 0){const r=n[e];if(!r)throw"Could not find game import '"+e+"'";return r}return n[e]=new t(e,i,o)};return{game:e}}(E);return O}();